<!doctype html>
<meta charset="utf-8" />
<title>Recent Labels</title>
<style>
  :root { --ok:#0a7d29; --err:#b00020; --muted:#555; --bg:#f6f8fa; --focus:#0366d6; --focus-bg:#e8f4fd; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin: 24px; }
  h1 { margin: 0 0 12px; }
  .muted { color: var(--muted); margin-bottom: 18px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
  .card { border: 1px solid #ddd; border-radius: 6px; padding: 0; background: #fff; cursor: pointer; transition: all 0.2s ease; position: relative; }
  .card:hover, .card:focus { border-color: var(--focus); background: var(--focus-bg); }
  .card:focus { outline: 2px solid var(--focus); outline-offset: 2px; }
  .card.selected { border-color: var(--focus); background: var(--focus-bg); box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3); }
  .card-content { padding: 12px; }
  .card img { width: 100%; height: auto; border: 1px solid #eee; pointer-events: none; }
  .meta { font-size: 12px; color: var(--muted); margin: 8px 0; pointer-events: none; }
  .delete-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 8px; width: 100%; }
  .delete-btn:hover, .delete-btn:focus { background: #c82333; outline: 2px solid var(--focus); }
  .status { margin-top: 4px; font-size: 12px; }
  .ok { color: var(--ok); }
  .err { color: var(--err); }
  .navigation-help { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 11px; z-index: 1000; }
  .home-link { display: inline-block; padding: 8px 12px; background: var(--focus); color: white; text-decoration: none; border-radius: 4px; margin-bottom: 12px; }
  .home-link:hover, .home-link:focus { background: #025aa5; color: white; outline: 2px solid var(--focus); }
</style>
<h1>Recent Labels</h1>
<div class="muted">Most recent previews from logs/. Click Reprint to send the label again.</div>
<div class="row" style="margin-bottom:12px;">
  <a href="/app" class="home-link" id="homeLink">Home</a>
</div>
<div id="container" class="grid"></div>
<div class="navigation-help">
  Arrow Keys: Navigate • Enter: Reprint • Delete: Remove • Tab: Next Element • Home: Return to main page
</div>
<script>
async function fetchRecent() {
  const res = await fetch('/api/recent');
  if (!res.ok) return [];
  const data = await res.json();
  return data.items || [];
}

async function reprint(path, statusEl) {
  statusEl.textContent = 'Reprinting…';
  statusEl.className = 'status';
  const res = await fetch('/api/reprint', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  });
  let body;
  try { body = await res.json(); } catch { body = { error: 'Invalid response' }; }
  if (res.ok && body.ok) {
    statusEl.textContent = `OK (elapsed ${body.elapsed_sec.toFixed(3)}s)`;
    statusEl.className = 'status ok';
  } else {
    statusEl.textContent = `Error: ${body.error || 'Unknown error'}`;
    statusEl.className = 'status err';
  }
}

async function deleteItem(path, statusEl, cardEl) {
  statusEl.textContent = 'Deleting…';
  statusEl.className = 'status';
  const res = await fetch('/api/delete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  });
  let body;
  try { body = await res.json(); } catch { body = { error: 'Invalid response' }; }
  if (res.ok && body.ok) {
    statusEl.textContent = 'Deleted';
    statusEl.className = 'status ok';
    // remove the card after a short delay
    setTimeout(() => cardEl.remove(), 300);
  } else {
    statusEl.textContent = `Error: ${body.error || 'Unknown error'}`;
    statusEl.className = 'status err';
  }
}

let selectedIndex = -1;
let cards = [];

function render(items) {
  const c = document.getElementById('container');
  c.innerHTML = '';
  cards = [];
  
  for (let i = 0; i < items.length; i++) {
    const it = items[i];
    const card = document.createElement('div');
    card.className = 'card';
    card.tabIndex = 0;
    card.dataset.index = i;
    card.dataset.path = it.path;
    
    const cardContent = document.createElement('div');
    cardContent.className = 'card-content';
    
    const img = document.createElement('img');
    img.src = it.image_url;
    img.alt = 'preview';
    
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = `${it.mtime_iso} • ${it.size} bytes`;
    
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'Delete';
    delBtn.tabIndex = -1;
    
    const status = document.createElement('div');
    status.className = 'status';
    
    // Make entire card clickable for reprint
    card.onclick = (e) => {
      if (e.target === delBtn) return; // Don't reprint if delete button was clicked
      reprint(it.path, status);
    };
    
    card.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        reprint(it.path, status);
      }
    };
    
    delBtn.onclick = (e) => {
      e.stopPropagation();
      deleteItem(it.path, status, card);
    };
    
    card.onfocus = () => {
      selectedIndex = i;
      updateSelection();
    };
    
    cardContent.appendChild(img);
    cardContent.appendChild(meta);
    cardContent.appendChild(delBtn);
    card.appendChild(cardContent);
    card.appendChild(status);
    c.appendChild(card);
    cards.push(card);
  }
  
  // Set initial selection to first card if any exist
  if (cards.length > 0) {
    selectedIndex = 0;
    updateSelection();
    cards[0].focus();
  }
}

function updateSelection() {
  cards.forEach((card, i) => {
    card.classList.toggle('selected', i === selectedIndex);
  });
}

function navigate(direction) {
  if (cards.length === 0) return;
  
  const oldIndex = selectedIndex;
  if (direction === 'up') {
    selectedIndex = Math.max(0, selectedIndex - Math.ceil(Math.sqrt(cards.length)));
  } else if (direction === 'down') {
    selectedIndex = Math.min(cards.length - 1, selectedIndex + Math.ceil(Math.sqrt(cards.length)));
  } else if (direction === 'left') {
    selectedIndex = Math.max(0, selectedIndex - 1);
  } else if (direction === 'right') {
    selectedIndex = Math.min(cards.length - 1, selectedIndex + 1);
  }
  
  if (oldIndex !== selectedIndex) {
    updateSelection();
    cards[selectedIndex].focus();
  }
}

function handleKeyPress(e) {
  if (cards.length === 0) return;
  
  switch(e.key) {
    case 'ArrowUp':
      e.preventDefault();
      navigate('up');
      break;
    case 'ArrowDown':
      e.preventDefault();
      navigate('down');
      break;
    case 'ArrowLeft':
      e.preventDefault();
      navigate('left');
      break;
    case 'ArrowRight':
      e.preventDefault();
      navigate('right');
      break;
    case 'Enter':
      e.preventDefault();
      e.stopPropagation();
      if (selectedIndex >= 0 && selectedIndex < cards.length) {
        const card = cards[selectedIndex];
        const path = card.dataset.path;
        const status = card.querySelector('.status');
        reprint(path, status);
      }
      break;
    case 'Delete':
    case 'Backspace':
      e.preventDefault();
      e.stopPropagation();
      if (selectedIndex >= 0 && selectedIndex < cards.length) {
        const card = cards[selectedIndex];
        const path = card.dataset.path;
        const status = card.querySelector('.status');
        deleteItem(path, status, card);
      }
      break;
    case 'Home':
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('homeLink').click();
      break;
  }
}

document.addEventListener('keydown', handleKeyPress);

(async function init() {
  const items = await fetchRecent();
  render(items);
})();
</script>
