<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Pi Label Printer</title>
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="/site.css">
</head>
<body>

    <div class="container">
        <h1>Pi Label Printer</h1>
        <form id="printForm">
            <div class="form-grid">
                <!-- Main Message -->
                <div class="form-group full-width">
                    <label for="message">Message</label>
                    <input type="text" id="message" name="message" placeholder="e.g., Happy Birthday!">
                </div>

                <!-- Border Messages -->
                <div class="form-group">
                    <label for="border_message">Top/Bottom Border</label>
                    <input type="text" id="border_message" name="border_message">
                </div>
                <div class="form-group">
                    <label for="side_border">Side Border</label>
                    <input type="text" id="side_border" name="side_border">
                </div>

                <!-- Count and Date -->
                <div class="form-group">
                    <label for="count">Count</label>
                    <input type="number" id="count" name="count" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="date">Date (optional)</label>
                    <input type="date" id="date" name="date">
                </div>

                <!-- Image Upload (Optional) -->
                <div class="form-group full-width">
                    <label>Image (optional)</label>
                    <label for="imageUpload" class="file-input-wrapper">
                        <div>Click to select an image</div>
                        <div id="fileName">No file chosen</div>
                    </label>
                    <input type="file" id="imageUpload" name="imageFile" accept="image/png, image/jpeg, image/gif">
                </div>
                
                <!-- Boolean Flags -->
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="show_date" name="show_date">
                    <label for="show_date">Show Date</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="preview_only" name="preview_only" checked>
                    <label for="preview_only">Preview Only (no printing)</label>
                </div>
            </div>

            <button type="submit" id="submitButton" class="submit-btn">Generate Label</button>
        </form>

        <div id="statusMessage"></div>
        <div id="previewContainer">
            <h2>Preview</h2>
            <img id="previewImage" src="" alt="Label Preview">
        </div>
    </div>

<script>
    const printForm = document.getElementById('printForm');
    const imageUploadInput = document.getElementById('imageUpload');
    const fileNameDisplay = document.getElementById('fileName');
    const submitButton = document.getElementById('submitButton');
    const statusMessage = document.getElementById('statusMessage');
    const previewImage = document.getElementById('previewImage');

    // Update file name display when a file is chosen
    imageUploadInput.addEventListener('change', () => {
        if (imageUploadInput.files.length > 0) {
            fileNameDisplay.textContent = imageUploadInput.files[0].name;
        } else {
            fileNameDisplay.textContent = 'No file chosen';
        }
    });

    printForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Stop default browser submission
        
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
        statusMessage.style.display = 'none';
        previewImage.style.display = 'none';

        let imagePathOnServer = null;
        const imageFile = imageUploadInput.files[0];

        // --- STEP 1: UPLOAD IMAGE (if one was selected) ---
        if (imageFile) {
            const imageUploadData = new FormData();
            imageUploadData.append('imageFile', imageFile);

            try {
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: imageUploadData
                });

                const uploadResult = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(uploadResult.error || 'Image upload failed.');
                }
                
                imagePathOnServer = uploadResult.filePath;
                updateStatus(`Image uploaded: ${imagePathOnServer}`, 'success');

            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                resetButton();
                return; // Stop the process
            }
        }

        // --- STEP 2: GATHER ALL FORM DATA AND SEND PRINT COMMAND ---
        const printPayload = {};
        const formData = new FormData(printForm);
        
        // Populate payload, skipping empty values
        for (const [key, value] of formData.entries()) {
            if (value) {
                // Handle checkboxes, which submit "on" if checked
                if (key === 'show_date' || key === 'preview_only') {
                    printPayload[key] = true;
                // Check if value is a string before trying to trim it
                } else if (typeof value === 'string' && value.trim() !== '') {
                    printPayload[key] = value;
                }
            }
        }

        // Add the uploaded image path to the payload
        if (imagePathOnServer) {
            printPayload.image = imagePathOnServer;
        }
        
        // Remove the form's own imageFile field from the payload
        delete printPayload.imageFile;

        try {
            const printResponse = await fetch('/api/pi-label/print', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(printPayload)
            });

            const printResult = await printResponse.json();

            if (!printResponse.ok) {
                const errorMsg = printResult.errors ? printResult.errors.join(', ') : printResult.error;
                throw new Error(errorMsg || 'Print command failed.');
            }

            updateStatus('Label generated successfully!', 'success');
            
            // Display the preview image
            if (printResult.preview_url) {
                // Add a timestamp to bust the cache and ensure the new image loads
                previewImage.src = `${printResult.preview_url}&t=${new Date().getTime()}`;
                previewImage.style.display = 'block';
            }

        } catch (error) {
            updateStatus(`Error: ${error.message}`, 'error');
        } finally {
            resetButton();
        }
    });

    function updateStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-${type}`;
        statusMessage.style.display = 'block';
    }

    function resetButton() {
        submitButton.disabled = false;
        submitButton.textContent = 'Generate Label';
    }
</script>

</body>
</html>